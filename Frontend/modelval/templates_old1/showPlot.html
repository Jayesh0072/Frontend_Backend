{% extends 'rmsebase.html' %} 
{% load static %} 
{% block content %} 
<style>
    .btn-circle.btn-xl {
    width: 30px;
    height: 30px;
    padding: 13px 13px;
    border-radius: 40px;
    font-size: 12px;
    text-align: center;
  }
</style>
<form method="POST" action="{{postAct}}" onsubmit="submitForm(event)">
    {% csrf_token %} 
    <div class="col-lg-12">
        <div class="card">
            <div class="card-header">
                {{chartType}}
                <input type="text" id="chart_type" value="{{chartType}}" hidden>
            </div>
            <div class="card-body card-block" style="padding-bottom: 0;">
                <div class="row">
                    <div class="col-lg-3"> 
                        <select  name="ddlvar1" id="ddlvar1" class="form-control" style="display:{{ hideddl1 }};">
                            {% for numcol in ddlvar1 %}
                                {% if  var1  == numcol %}
                                    <option value="{{ numcol }}" selected="selected"> {{ numcol }}</option>                                                    
                                {% else %}
                                    <option value="{{ numcol }}">{{ numcol }}</option>                                                    
                                {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-lg-3"> 
                        <select name="ddlvar2"  id="ddlvar2" class="form-control" style="display:{{ hideddl2 }};">
                            {% for catcol in ddlvar2 %}
                                {% if  var2  == catcol %}
                                    <option value="{{ catcol }}" selected="selected"> {{ catcol }}</option>                                                    
                                {% else %}
                                    <option value="{{ catcol }}">{{ catcol }}</option>                                                    
                                {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-lg-3">     
                        <button type="submit" class="btn btn-primary btn-sm" >Update</button>
                        <button type="button" class="btn btn-primary btn-sm" onclick="goBack();" >Back</button>
                        
                    </div>
                    <div class="col-lg-3"  style="display: flex; justify-content: flex-end;">
                        <a style="margin-right: 5px;" href="{{ pdfFile }}" download> <i class="fa fa-download" style="font-size: 12px;" title="Export to PDF"></i> </a>
                        <a style="margin-right: 5px;" href="#" onclick="shoeTune()"><i class="bi bi-chat-right-quote" style="font-size: 12px;" title="Add comments"></i></a>
                        <a style="margin-right:5;" href="#" onclick="showFilename()"><i class="bi bi-save" style="font-size: 12px;" title="Save chart image"></i></a>
                    </div> 
                </div>
                <div class="row" style=" height:15px ;">  </div>
                <div style="height: 100%;overflow:scroll"> 
                    <div class="row">
                        <div class="col-lg-12">
                            <img id="imgGraph" style="cursor: zoom-in;height: 100%;width:100%" src="{{ graphpath }}">
                        </div>

                    </div> 
                </div> 
            </div>
            
        </div>
    </div>
    
    <!-- <div class="modal fade" id="divTune" tabindex="-1" aria-labelledby="divTune" aria-hidden="true">

        <div class="modal-dialog modal-md modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="scrollingLongModalLabel2">Comments </h5>
                    <button class="btn p-1" type="button" data-bs-dismiss="modal" aria-label="Close"><span
                            class="fas fa-times fs--1"></span></button>
                </div>
                <div class="modal-body p-5 px-md-6">
                    <div class="row form-group"
                        style="padding-bottom:0px;margin-bottom:0px;padding-top:0px;margin-top:0px;">
                        <div class="col col-md-2">
                            <label class=" form-control-label">Comments
                            </label>
                        </div>
                    </div>
                    <div class="row form-group"
                        style="padding-bottom:0px;margin-bottom:0px;padding-top:0px;margin-top:0px;">
                        <div class="col-12 col-md-12">
                            <textarea id="txtReportComments" rows="10"
                                style="resize: none;width: 100%;font-size: 10pt;"
                                class="form-control form-control-sm"></textarea>
                        </div>
                    </div>


                </div>
                <div class="modal-footer">
                    <div class="col-auto" style="display: flex; justify-content: flex-end;">
                        <button type="button" class="btn btn-primary btn-sm" style="margin-right: 10px;"
                            onclick="saveReportComment()">Save</button>
                    </div>
                </div>
            </div>
        </div>
    </div> -->
    <div class="modal fade" id="divTune" tabindex="-1" aria-labelledby="divTune" aria-hidden="true">
        <div class="modal-dialog modal-md modal-dialog-scrollable"> 
         <div class="modal-content">
           <div class="modal-header">
             <h5 class="modal-title" id="scrollingLongModalLabel2">Comments </h5>
             <button class="btn p-1" type="button" data-bs-dismiss="modal" aria-label="Close"><span class="fas fa-times fs--1"></span></button>
             <div class="d-flex">
               <button class="btn btn-icon btn-primary btn-circle btn-xl" id="btnchat" onclick="toogleChat('chat')"><i class="bi bi-chat-text"></i></button>
               <button class="btn btn-icon btn-primary btn-circle btn-xl" style="display: none;" id="btncomment" onclick="toogleChat('comment')"><i class="bi bi-chat-quote"></i></button>
              
             </div>
           </div>
           <div class="modal-body p-5 px-md-6">  
               <div class="chat-content tab-content flex-1" style="flex: 1;">
                   <div class="tab-pane h-100 fade active show" id="tab-thread-1" role="tabpanel" aria-labelledby="tab-thread-1">
                     <div class="card flex-1 h-100"> 
                       <div id="divChatHeader" style="display: none!important;;overflow: auto !important;" class="card-body p-3 p-sm-4 d-flex flex-column scrollbar">
                           <div class="row mb-3 position-relative">
                               <div  class="col-sm-12">
                                   <div class="d-flex flex-column h-100 p-3" id="divresp_4" style="overflow-y: scroll;;height: 100px !important;">
                                       
                                     
                                     
                                   </div>
                               </div>
                           </div>                           
                       </div>
                       <div id="divChatfooter" style="display: none;"  class="card-footer">                    
                         <div class="row mb-3 position-relative">
                           <div  class="col-sm-11">
                             <textarea id ="txtcomment" rows="2" style="width: 100%;resize: none;"></textarea>
                           </div> 
                           <div class="col-sm-1">                   
                             <div class="d-flex justify-content-end align-items-end">
                              
                               <div>
                                 <button class="btn btn-icon btn-primary btn-circle btn-xl" type="button" onclick="updateResponse()">
                                   <i class="bi bi-send"></i></button>
                               </div>
                             </div>
                           </div>
                         </div> 
                       </div>      
                       
                       <div id="divRespHeader" style="display: none;" class="card-body p-3 p-sm-4 d-flex flex-column scrollbar">
                         <div class="row mb-3 position-relative">
                           <div  class="col-sm-12">
                             <textarea id ="txtReportComments" onkeyup="enableSave()" rows="12"  style="width: 100%;resize: none;"></textarea>
                           </div>                        
                         </div>
                          
                                           
                         <div class="row mb-3 position-relative">
                         
                           <div class="col-sm-12">                   
                             <div class="d-flex justify-content-end align-items-end">
                              
                               <div>
                                 <button class="btn btn-primary" disabled type="button" id="btnSave" onclick="saveReportComment()">Save
                                   </button>
                               </div>
                             </div>
                           </div>
                         </div> 
                       </div> 
                     </div>
                   </div> 
                 </div>
  
                
           </div>
           <!-- <div class="modal-footer">
               <div class="col-auto" style="display: flex; justify-content: flex-end;">
                   <button type="button" class="btn btn-sm" style="margin-right: 10px;" onclick="$('#divTune').modal('toggle')" >Cancel</button> 
               <button type="button" class="btn btn-primary btn-sm" style="margin-right: 10px;" onclick="saveReportComment()" >Save</button>
               </div>
           </div> -->
         </div>
       </div> 
    
   </div>



   
<div id="divFilename" class="modal fade"    tabindex="-1" role="dialog" aria-labelledby="staticBackdropLiveLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title" id="staticBackdropLiveLabel">Save Image</h5>        
        </div>
        <div class="modal-body"> 
            <div style="width:100%">
                
                <div class="row form-group"> 

                    <div class="col-12 col-md-2"> 
                        File Name : 
                    </div>
                    <div class="col-12 col-md-9"> 
                        <input type="text" style="border:1px solid black;width:100%;"  id="txtchartFile"/>
                    </div>
                </div>
            </div> 
    </div>
    <div class="modal-footer"> 
      <button  type="button" class="btn btn-primary parse-json" onclick="saveimage()">Save</button>
      <button type="button" class="btn btn-primary px-5 px-sm-5" onclick="$('#divFilename').modal('toggle');">Close</button>
    </div>
  </div>
</div>
</div>

<div id="divComment" class="modal fade"    tabindex="-1" role="dialog" aria-labelledby="staticBackdropLiveLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title" id="staticBackdropLiveLabel">Save Comment</h5>        
        </div>
        <div class="modal-body"> 
            <div style="width:100%">
                <input type="text" value="{{chartType}}" id="txtchartType" style="display: none;"/>
                <textarea id="txtcomment" rows="5" style="resize: none; border:1px solid black;width:100%;" ></textarea>
           </div> 
        </div>
    <div class="modal-footer"> 
        <button type="button"  class="btn btn-primary parse-json" onclick="savecomment()">Save</button>
        <button type="button" class="btn btn-primary px-5 px-sm-5" onclick="$('#divComment').modal('toggle');">Close</button>
    </div>
  </div>
</div>
</div>

</form>


{% endblock content %}
{%  block script %}
<script src="{% static 'js/main.js' %}"></script>
<script src="{% static 'jquery-3.5.1.js' %}"></script>
<!-- Jquery JS-->
<script src="{% static 'vendor/jquery-3.2.1.min.js' %}"></script>
<script src="{% static 'dataTables.min.js' %}"></script> 
<script src="{% static 'js/chatroom.js' %}"></script>
<script type='text/javascript'> 
    $(document).ready(function () {
        connectWS('{{request.session.vt_mdl}}')
        debugger
        $("#txtSelUtil").val('View Multivariate Graphs')
        $("#txtSelSubUtil").val($('#chart_type').val())
        $("#txtSelUtilType").val('table')
        getVT_Comm_History('divresp_4','View Multivariate Graphs', $('#chart_type').val(),'{{request.session.vt_mdl}}')
        // $.ajax({ 
        // url: '/ValidationCommentHistory/',
        // data:{'utility':'View Multivariate Graphs','subutility': $('#chart_type').val(),'chat_data':$('#ddlvar1').val()+' '+'|'+' '+$('#ddlvar2').val(),'mdl_id':'{{request.session.vt_mdl}}'},
        // dataType: 'json',
        // success: function (data) {
        //   debugger  
        //   console.log("comment",data)
        //   $('#txtReportComments').val(data.comment) 
        //   qtnArr = '';
        //   $.each(data.data, function(key, val) {
        //     console.log("key------",key,"val----------",val)
        //     // qtnArr +=' <div class="d-flex chat-message">';
        //     // qtnArr +='         <div class="d-flex mb-2 flex-1">';
        //     // qtnArr +='           <div class="w-100 w-xxl-75">';
        //     // qtnArr +='             <div class="d-flex hover-actions-trigger">';                     
        //     // qtnArr +='               <div class="chat-message-content received me-2">';
        //     // qtnArr +='                 <div class="mb-1 received-message-content border rounded-2 p-3">';
        //     // qtnArr +='                    <p class="mb-0">'+val.Comment+'</p>';
        //     // qtnArr +='                 </div>';
        //     // qtnArr +='     </div>         ';                  
                  
        //     // qtnArr +='  </div>';
        //     // qtnArr +='   <p class="mb-0 fs--2 text-600 fw-semi-bold ">'+val.uinitials +' commented on '+val.createdt+'</p>';
        //     // qtnArr +=' </div>';
        //     // qtnArr +=' </div>';
        //     // qtnArr +='  </div>';
        //     if(val.msgcss=='R')
        //     {
        //       qtnArr +=' <div class="d-flex chat-message">';
        //       qtnArr +='         <div class="d-flex mb-2 flex-1">';
        //         qtnArr +='           <div class="w-100 w-xxl-75">';
        //           qtnArr +='             <div class="d-flex hover-actions-trigger">';                     
        //             qtnArr +='               <div class="chat-message-content received me-2">';
        //               qtnArr +='                 <div class="mb-1 received-message-content border rounded-2 p-3">';
        //                 qtnArr +='                    <p class="mb-0">'+val.Comment+'</p>';
        //                 qtnArr +='                 </div>';
        //                 qtnArr +='     </div>         ';                  
                             
        //                 qtnArr +='  </div>';
        //                 qtnArr +='   <p class="mb-0 fs--2 text-600 fw-semi-bold ">'+val.uinitials +' commented on '+val.createdt+'</p>';
        //                 qtnArr +=' </div>';
        //                 qtnArr +=' </div>';
        //                 qtnArr +='  </div>';
        //     }
        //     else if(val.msgcss=='S')
        //     {

        //       qtnArr +=' <div class="d-flex chat-message">';
        //         qtnArr +=' <div class="d-flex mb-2 justify-content-end flex-1">';
        //         qtnArr +=' <div class="w-100 w-xxl-75">';
        //           qtnArr +=' <div class="d-flex flex-end-center hover-actions-trigger">';
        //           qtnArr +=' <div class="d-sm-none hover-actions align-self-center me-2 start-0">';                 
                  
        //             qtnArr +='<div class="bg-white rounded-pill d-flex align-items-center border border-300 px-2 actions">';
        //               // qtnArr +='<button class="btn p-2" type="button"><span class="fa-solid fa-reply text-primary"></span></button>';
        //               qtnArr +='<button class="btn p-2" type="button"><span class="fa-solid fa-pen-to-square text-primary"></span></button>';
        //               // qtnArr +='<button class="btn p-2" type="button"><span class="fa-solid fa-trash text-primary"></span></button>';
        //               // qtnArr +='<button class="btn p-2" type="button"><span class="fa-solid fa-share text-primary"></span></button>';
        //               // qtnArr +='<button class="btn p-2" type="button"><span class="fa-solid fa-face-smile text-primary"></span></button>';
        //               qtnArr +='</div>';
        //               qtnArr +='</div>';
        //           qtnArr +='   <div class="d-none d-sm-flex">';
        //             qtnArr +=' <div class="hover-actions position-relative align-self-center">';
        //               // qtnArr +=' <button class="btn p-2 fs--2"><span class="fa-solid fa-reply text-primary"></span></button>';
        //               qtnArr +=' <button class="btn p-2 fs--2" onclick="getCommentforEdit(' + val.Response_id +')" ><span class="fa-solid fa-pen-to-square text-primary" ></span></button>';
        //               // qtnArr +=' <button class="btn p-2 fs--2"><span class="fa-solid fa-share text-primary"></span></button>';
        //               // qtnArr +=' <button class="btn p-2 fs--2"><span class="fa-solid fa-trash text-primary"></span></button>';
        //               // qtnArr +=' <button class="btn p-2 fs--2"><span class="fa-solid fa-face-smile text-primary"></span></button>';
        //               qtnArr +='  </div>';
        //               qtnArr +=' </div>';
        //             qtnArr +=' <div class="chat-message-content me-2">';
        //               qtnArr +='  <div class="mb-1 sent-message-content light bg-primary rounded-2 p-3 text-white">';
        //                 qtnArr +=' <p class="mb-0">'+val.Comment+'</p>';
        //                 qtnArr +=' </div>';
        //                 qtnArr +='  </div>';
        //                 qtnArr +=' </div>';
        //                 qtnArr +=' <div class="text-end">';
        //                   qtnArr +=' <p class="mb-0 fs--2 text-600 fw-semi-bold">'+val.uinitials +' commented on '+val.createdt+' </p>';
        //                   qtnArr +=' </div>';
        //                   qtnArr +=' </div>';
        //                   qtnArr +=' </div>';
        //                   qtnArr +=' </div> ';
        //     } 
        //   }) 
        //   $('#divresp_4').append(qtnArr)       
        //   }
        // });
        $('#liDataV').click(function(){
            $('#sub_sub_menu').hide();
        });
        var zoomin=0;  
        $('#imgGraph').click(function(){  
            if(zoomin==0)
            { 
                zoomin=1; 
                $('#imgGraph').css("transform", "scale(2.5)");
                $('#imgGraph').css('transform-origin','0px 0px'),
                $('#imgGraph').css({'cursor':'zoom-out'});
            }
            else if(zoomin==1)
            {
                zoomin=0; 
               $('#imgGraph').css("transform", "scale(1)");
               $('#imgGraph').css('transform-origin','0px 0px'),
                $('#imgGraph').css({'cursor':'zoom-in'});
            } 
        }); 
    });

    function enableSave(){ 
        if($("#txtReportComments").val().length>0){
            $("#btnSave").prop("disabled",false)
        }
        else{
            $("#btnSave").prop("disabled",true)
        }
    }

    function toogleChat(id){
        debugger
      var myClass = $("#iconmsg").attr("class"); 
      if(id=='chat'){ 
        debugger      
        $("#btncomment").show();
        $("#btnchat").hide();
        $("#divChatHeader").show();
        $("#divChatfooter").show();
        $("#divRespHeader").attr('style','display:none !important'); 
        return true;
      }
      else{
        debugger
        $("#btncomment").hide();
        $("#btnchat").show();
        $("#divChatHeader").attr('style','display:none !important');
        $("#divChatfooter").attr('style','display:none !important');
        $("#divRespHeader").show(); 
        return true;
      }
      
    }

    function submitForm(event){
        event.preventDefault();


    }

    function shoeTune(){
        debugger
        $("#divTune").modal('toggle')
    }
    
    function saveReportComment()
    { 
    $.ajax({ 
        url: '/save_desc_comments/',
        data:{'utility':'View Multivariate Graphs','tableType':'{{chartType}}','type':'chart','comment':  $("#txtReportComments").val(),
        '   chartImg': $('#txtchartFile').val(),'chartType':$("#txtchartType").val(),
            'xaxisval':$("#ddlvar1").val(),'yaxisval':$("#ddlvar2").val()},
        dataType: 'json',
        success: function (data) {
                if(data.is_taken)
                { 
                alert('Comment saved sucessfully.')             
                }   
        }
        });
    }     

    function  goBack()
    {
        window.location="{% url 'showChartTypes' %}"
    }

    function savecomment(){
        $.ajax({ 
            url: '/saveChartComments/',
            data:{ comments: $('#txtcomment').val(),'chartType':$("#txtchartType").val(),'xaxisval':$("#ddlvar1").val(),'yaxisval':$("#ddlvar2").val(),}, 
            dataType: 'json',
            success: function (data) {
                    if(data.is_taken)
                    {
                        alert('Comments saved successfully.')
                        $('#divComment').modal('toggle');
                    }            
            }
        }); 
        $(this).dialog("close");
    }

    function showComment()
    {  
        
         $("#divComment").modal('toggle')
    //     $("#divComment").dialog({   
    //         width: "70%",   
    //         modal: true,
    //         buttons:             /* Save: function() {
    //             $(this).dialog("close");
    //             } */ [
    //             {
    //                 text: "Save",
    //                 "class": 'btn btn-primary btn-sm',
    //                 click: function() {  
    //                     $.ajax({ 
    //                         url: '/saveChartComments/',
    //                         data:{ comments: $('#txtcomment').val(),'chartType':$("#txtchartType").val()}, 
    //                         dataType: 'json',
    //                         success: function (data) {
    //                                 if(data.is_taken)
    //                                 {
    //                                     alert('Comments added to pdf file.')
    //                                 }            
    //                         }
    //                     }); 
    //                     $(this).dialog("close");
    //                 }
    //             },
    //             {
    //                 text: "Cancel",
    //                 "class": 'btn btn-primary btn-sm',
    //                 click: function() {
    //                     // Save code here
    //                     $(this).dialog("close");
    //                 }
    //             }
    //         ],  
    //     }); 
    }

    function saveimage() 
    {  
        console.log('$("#ddlvar1").val() ',$("#ddlvar1").val())
        $.ajax({ 
            url: '/saveChartImage/',
            data:{ 'chartImg': $('#txtchartFile').val(),'chartType':$("#txtchartType").val(),'xaxisval':$("#ddlvar1").val(),'yaxisval':$("#ddlvar2").val()}, 
            dataType: 'json',
            success: function (data) {
                    if(data.is_taken)
                    {
                        alert('Image saved successfully.')
                        // $('#divFilename').modal('toggle');
                    }            
            }
        }); 
        $(this).dialog("close");
    }

    

    function updateResponse(){
        
        $.ajax({ 
        url: '/insert_VT_Discussion_Comments/',
        data:{'utility':'View Multivariate Graphs','tableType': $('#chart_type').val(),'comment':  $("#txtcomment").val(),'chat_data':$('#ddlvar1').val()+' '+'|'+' '+$('#ddlvar2').val(),'mdl_id':'{{request.session.vt_mdl}}'},
        dataType: 'json',
        success: function (data) {  
                    
                if(data.is_taken)
                { 
                    // sendPerfMonmsg($("#txtcomment").val(),'{{ request.session.uid }}',9,5,'vt_discussion','VT_Diss_{{request.session.vt_mdl}}',JSON.parse(data.data)[0].uinitials+' commented on '+ JSON.parse(data.data)[0].createdt) 
                    
                    sendPerfMonmsg($("#txtcomment").val(),'{{ request.session.uid }}',9,5,'vt_discussion','{{request.session.vt_mdl}}',JSON.parse(data.data)[0].uinitials+' commented on '+ JSON.parse(data.data)[0].createdt,'View Multivariate Graphs',$('#chart_type').val(),'table')   
                  
                  
                }   
        }
        });
    }


    function showFilename()
    {  
        saveimage();
       // $("#divFilename").modal('toggle')
        // $("#divFilename").dialog({   
        //     width: "50%",   
        //     modal: true,
        //     buttons:             /* Save: function() {
        //         $(this).dialog("close");
        //         } */ [
        //         {
        //             text: "Save",
        //             "class": 'btn btn-primary btn-sm',
        //             click: function() {  
        //                 $.ajax({ 
        //                     url: '/saveChartImage/',
        //                     data:{ 'chartImg': $('#txtchartFile').val(),'chartType':$("#txtchartType").val()}, 
        //                     dataType: 'json',
        //                     success: function (data) {
        //                             if(data.is_taken)
        //                             {
        //                                 alert('Image saved successfully.')
        //                             }            
        //                     }
        //                 }); 
        //                 $(this).dialog("close");
        //             }
        //         },
        //         {
        //             text: "Cancel",
        //             "class": 'btn btn-primary btn-sm',
        //             click: function() {
        //                 // Save code here
        //                 $(this).dialog("close");
        //             }
        //         }
        //     ],  
        // }); 
    }
 
</script>
{% endblock script %}